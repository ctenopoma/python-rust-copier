#!/usr/bin/env bash
set -euo pipefail

# Build automation script for {{ project_name }} (Linux/macOS)

DOCS=false

show_help() {
    cat <<EOF
Build automation script for {{ project_name }}

USAGE:
    ./build.sh [OPTIONS]

OPTIONS:
    --docs, -d     Build Sphinx documentation after tests
    --help, -h     Display this help message

EXAMPLES:
    ./build.sh              Run full build pipeline
    ./build.sh --docs       Run pipeline and build docs
    ./build.sh -h           Show this help

STEPS:
    1. uv sync --group dev
    2. uv run maturin develop
    3. uv run ruff check
    4. uv run ruff format --check
    5. uv run pyrefly
    6. cargo fmt -- --check
    7. cargo clippy -- -D warnings
    8. uv run pytest
    9. cargo test
   10. uv build
   11. (Optional) uv run sphinx-build -b html docs build/docs

EOF
}

write_step() {
    echo -e "\n\033[0;36m==> $1\033[0m"
}

invoke_step() {
    local description="$1"
    shift
    write_step "$description"
    if ! "$@"; then
        echo -e "\033[0;31mError: $description failed\033[0m" >&2
        exit 1
    fi
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --docs|-d)
            DOCS=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            show_help
            exit 1
            ;;
    esac
done

echo -e "\033[0;32m{{ project_name }} Build Pipeline\033[0m"
echo -e "\033[0;32m====================================\033[0m"

# Step 1: Sync dependencies
invoke_step "Syncing dependencies" uv sync --group dev

# Step 2: Build extension in develop mode
invoke_step "Building extension (maturin develop)" uv run maturin develop --quiet

# Step 3-5: Python linting
invoke_step "Running ruff check" uv run ruff check
invoke_step "Running ruff format check" uv run ruff format --check
invoke_step "Running pyrefly" uv run pyrefly

# Step 6-7: Rust linting
invoke_step "Running cargo fmt check" cargo fmt -- --check
invoke_step "Running cargo clippy" cargo clippy -- -D warnings

# Step 8-9: Tests
invoke_step "Running Python tests (pytest)" uv run pytest
invoke_step "Running Rust tests (cargo test)" cargo test

# Step 10: Build artifacts
invoke_step "Building wheel and sdist" uv build

# Step 11: Optional docs
if [ "$DOCS" = true ]; then
    invoke_step "Building Sphinx documentation" uv run sphinx-build -b html docs build/docs
    echo -e "\n\033[0;32m✓ Documentation built: build/docs/index.html\033[0m"
fi

echo -e "\n\033[0;32m✓ Build pipeline completed successfully!\033[0m"
echo -e "\033[0;90m  Artifacts: dist/\033[0m"
if [ "$DOCS" = true ]; then
    echo -e "\033[0;90m  Docs: build/docs/\033[0m"
fi
